<!DOCTYPE html>
<html>
<head>
	<title>Gridster Test</title>
	<link rel="stylesheet" type="text/css" href="base.css">
	<link rel="stylesheet" type="text/css" href="gridster.js-master/dist/jquery.gridster.css">

	<script type="text/javascript" src="assets/jquery.min.js"></script>
	<script type="text/javascript" src="gridster.js-master/dist/jquery.gridster.js"></script>

</head>
<body>
	<div class="gridster">
		<ul>
		</ul>
	</div>
	<script type="text/javascript">
		var gridster;

		$(function() { //DOM Ready
			var tiles = [];
			var columns = 6;
			var win_width = window.innerWidth;
			var size = Math.floor(win_width / columns);
			var scale = 3;
			var ratios = [ [3,3], [4,3], [3,4], [5,3], [6,4] ];

			for(var i = 0; i < columns * 10;i++)
				tiles[i] = ['<li>' + i + '</li>', 1, 1];


			gridster = $(".gridster ul").gridster({
				widget_margins: [0, 0],
				widget_base_dimensions: [size, size],
				min_cols: [columns],
				draggable: {handle: 'none'}
			}).data('gridster');

			$(window).resize(function() {
				
			});

			var dir = 'assets/imgs/';
			var regexp = new RegExp("\.png|\.jpg|\.gif");
			var regexpVid = new RegExp("\.webm|\.mp4");

			$.ajax({
				url: dir,
				success: function (data) {
					$(data).find("a").filter(function () {return regexp.test($(this).text()) || regexpVid.test($(this).text());}).each(function () {
						var filename = this.href.replace(window.location.host, "").replace("http://", "").replace("/gridster-test/", "");
						var widget;
						if(regexpVid.test(filename)) 
							widget = ["<li><video loop><source src='" + dir + filename + "'></video></li>", 1, 1];
						else
							widget = ["<li><img src='" + dir + filename + "'></li>", 1, 1];

						gridster.add_widget(widget[0], widget[1], widget[2]).click(function() {
							
							var content_width, content_height;
							var $content = $($(this).children()[0]);
							var $active = $('.active');

							if($(this).hasClass('active')) {
								gridster.resize_widget($(this).removeClass('active'), 1, 1);
								if($content.is('video')) {
									$content[0].pause();
									$content[0].currentTime = 0;
								}
							} else {
								if($active.length) {
									gridster.resize_widget($active.removeClass('active'), 1, 1);
									var $active_content = $($active.children()[0]);
									if($active_content.is('video')) {
										$active_content[0].pause();
										$content[0].currentTime = 0;
									}
								}

								if($content.is('img')) {
									content_width = $content[0].naturalWidth;
									content_height = $content[0].naturalHeight;
								} else if($content.is('video')) {
									content_width = $content[0].videoWidth;
									content_height = $content[0].videoHeight;
									$content[0].play();
									$content[0].volume = .3;
								}
								var ratio = getClosestRatio(content_width, content_height);
								var $widget = gridster.resize_widget($(this).addClass('active'), ratio[0], ratio[1]);
								var scroll_distance = columns - ($widget.offset().left / size) - ratio[0];
								
								var index = $('li').index($(this));
								var scroll = (Math.floor((index / columns)) - .5) * size;

								if(scroll_distance < 0) scroll_distance *= size * -1;
								console.log(scroll);
								$(document.body).animate({
									scrollLeft: scroll_distance,
									scrollTop: scroll
								}, 250, 'linear');
								
							}
							/* 
							// old resize method
							var resize = Math.ceil($(this).height() / size) == 1 ? 3 : 1;
							gridster.resize_widget($(this), resize, resize, true);
							*/
						});
						
					});
				}
			});

			function getClosestRatio(width, height) {
				var num = width / height;

				curr = ratios[0];
				for(var i = 0, ratio; ratio = ratios[i];i++) {
					if (Math.abs(num - (ratio[0]/ratio[1])) < Math.abs(num - (curr[0]/curr[1])) ) curr = ratio;
				}
				return curr;
			}
		});
	</script>
</body>
</html>